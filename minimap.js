///<reference path="/alt1lib.js">
///<reference path="/runeappslib.js">
///<reference path="/imagedetect.js">
///<reference path="/apps/alt1/alt1doc.js">
"use strict";

MinimapReader.homeportbutton = null; ImageData.fromBase64(function (i) { MinimapReader.homeportbutton = i; }, "iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAIAAAC0tAIdAAAA70lEQVQoU4WSoW4CQRRF5ydQdUgcAsEaEpIK1P4AAdUQXAXB4FuNgiCKJdUVdYsihKQG+IKmAgFyg8D0TO7mMRkamhzx3n3nzWwy694+fz62+XTy9dx6fWoMIwgZIaC16333vjr2B3OqOyCgseB6nVla64bIiEI0bnBqHitpfr6AjUEJI7WjceZterNV3yZoXOiiWVJuGqENLBS2zaoPiVQKJdS2cLV33/mfxLZOiiRDtxU2VWhXSlUjtIW36Zmt9ycIbUtswUmF5eYAmim0RKH/EjXA24IGsi0RvL9/HevvgOb/k5fF9t8FBLTROPsFtJgUMNwTN50AAAAASUVORK5CYII=");

ImageData.fromBase64(i=>MinimapReader.energies.botrun.img = i, "iVBORw0KGgoAAAANSUhEUgAAABYAAAAKCAYAAACwoK7bAAACbElEQVQ4T32Sy2sTURTGZ2uazKMZiJKkpknaPE1aFYogbgQ3RfCxkvqgiqb2EZNi2tiaTOrENslQsZWKQVAXvmp8QWzTdiEIrqSlIRWsYuvChRvxX/g8d8BSRV183Ln3fPfHd84dTmupRz5cD3WHhIRXQO7INnxZaMSPNw2oxIyoZXjEdkpI+kVkQxLS5Ov2yiif2qJ7lHazXhulGuMUiMeY3GhAQsYr4qKbR39Ywvd3XqyM8FiOGlBN8UjtE/TaFfLk/BLUoIQ47e8fr8PXmxLKIyH00H6oWdA5WZ+IAnm4FJn7qXDeb8LarEOH1hQe2mEZEYcJg03CBrRAIcZoHSZIl1PA9BkDdedAh82oe4un3XpHGiXnIkEZ1XtWfCuZsdhjwNQJM87SpbiL0noEXKUEDJonKAOzlaVKuAXEqMMPEyJKigXvH1rx5JwB6d0ilDYLuL727VgZF7HUa8BJuxFRJ4/LBFT/AG4WO1c8IvrIWx4wYXVSxOM99D5sbCEZuY4mcMW0G88HJSynefQ6TTqUtfs34GaxTpI0Ju2QjEeddeiicUb9ZqSOOlGZ8oN7+8CKO6lGvL5mRLzNBjVAw6eZapTof8o3i1AJPEzAJIWJ77JCORbAqxs+fKw0gAPALU7bUJr0Itftw6UDDmTDMjR6II0l+ocKpDwpE6Lfje6MXwhg4W4QnwnKmDqYaXXGgqWnDszc8uB6pAVD+10Y2GtHvlVGgUazAWRjojNWYx7mnS16UH3hwNr8Vh36G5hpfc6K9XkLai9dmLvtw7OxMCbiIaidQSQOtupi3+yM1ZiHedmdTxU7IX6xwP0EFsu8kp8kDHUAAAAASUVORK5CYII=");
ImageData.fromBase64(i=>MinimapReader.energies.toprun.img = i, "iVBORw0KGgoAAAANSUhEUgAAABYAAAAKCAYAAACwoK7bAAACWUlEQVQ4T12SXUhTYRjHdxvYxfIqaWfn+3ub07lJow8JvegmdEUZFQZWSIGJ0IUQFNSIgYHBxAvrouiqgiiKCCrrLiIIKcEIdRM/qjkvKjQI/j3Pa1utiz/nPed9/7/n/zzvCQCo0dL0WayXTuJXuRc/FruxMnMASx8zWJjqEuI1f+M9PsNn2fM/p7ooTPZj7esJfF88ivkPGdwe24Xjh3zsSGrwbBmGJkFTQrD1EFrjMno6bdzM70TxfUZ42MuMGnBpuhdry0doYx/OD7SiOapA18JVuY4Jy9TgO2Gc64uhsz0MSWqASoXivoKh/pTwMoNZArz66Ri+LRzEg1u7kU6oAuS5Vo0c24CmyZh6pODnrCk0eCoG01DhUFH2bCcvM5jFzMDq3H6MXE7BMWUB4XQMsi0dUd8S8l1DmFcmJJTf2ii/lHBn1IOmyrDonG0ZwuNZYVzLJsHMQP5KCqa+kZKhDIp4Os1VgaHLlEqGrkqQQg14NxzE8r16ofvZOtimQuPRkRvyYNKoGM6s4YtJBHy6mErLsahNcB1v7qpYnzHx+bWN6ScqHt7wMZZNYPaZIqDjA1uosArLUHDpTKMYzd42eqf0ghOxEOBFU6MrtNG2JYCTV4Mojv5NyO1XxjAxson+kLC40K42BV+eS+juUKhTE/GYK+BVcDzmkHy0p3UUntZjT4uCdFxFT8dWFPNBzFMRASdxoesXtkEJh3D6sIHSCwmeGKNZDRmoLFqaY9SCi/FcBI9zdXBtk0R/A11QgcD/Jucnt58d1MXIXvVtprQ2Ek3RP2AXvwFBOdopSrlbYgAAAABJRU5ErkJggg==");
ImageData.fromBase64(i=>MinimapReader.energies.botwalk.img = i, "iVBORw0KGgoAAAANSUhEUgAAABYAAAAKCAYAAACwoK7bAAABYUlEQVQ4T52QS0sCURiGzz+IGqNVLaICnRCKxGvo1EiUgUQWZdSUBYKBKG1sI+KlsU5EGVK0iKAoiKCgH/g23xGnGZyFuHhg5jvv+5wLu56XYOVSmcRPK4v3eholTQHPraDhG7NlmnMSCik/vlsHIm9d68Ku5GEQ9FP3uvD7lEflWBG0c6uo+cfNcDdL3KV8eDzfxvPJkjmzZkxxQx7BV1MDzyfAs3HoqtsMOdE0qO4E8KkfmrOb2BTqhoe+hfi1oOKtvAWeUXC77oXu6RU5UfOO4uFswzj1Mj7Ku6hkYqjNdk4txC/FBKrpYE+xH/h+RDwJ9fXwhDlnasgNvrmA9umardA36gz4XggXlluSk0UXg4hHPLjXosY7WwoDQlJyMgAsoCpiUPJI4NNDA0FdcpCLnEJMxJJJhIM+HMkusbNT2QnKUoe6ATUhpDZxF9qRQrQ7FZxuQTNao0xH2DnlP2B/M7mmqCM7tWUAAAAASUVORK5CYII=");
ImageData.fromBase64(i=>MinimapReader.energies.topwalk.img = i, "iVBORw0KGgoAAAANSUhEUgAAABYAAAAKCAYAAACwoK7bAAAB30lEQVQ4T2WS204TURSG5x1owAOHqHVKWwotbZ1MaUsjJKLU1A5WA2oNwRCLFSFtgxgMIQESg5SCChjjjaQ18RC9MOEFjK/1O/8iM+m0F99kzd7/+vaelVEAOPhcb2B9bxcLxQWkMhlo0RDcV/rQdeGiwJpr3GOGWfa0etqExlRWmiP9LuiXzyGudmPoai887j6BdcLTjeSlTskwO5lOtx0gj71aDbNzTyQU87kQVXuktvD7PGd4VRg3NUSDqr0XNrO62cOaDrpEzJPGryfh7z+PmHk7h6iF99tzOK2v4N/PCm7diNvr7NHNAwZMB110KqMJHRFvJ/zuXoeEDAd9Dr5VH+L3xyX8OshjeyXXlg+YYwp7XAiPpKBwTpydtUlBaMgrtIrfrRk4Xr2HxuYMXhUNe/1xbszupys50AFl0DylWUq2Vmfw56SC+ofn+PT2Kd68zmNt+T5OqgURl59N4FokKNnpbErGo0UDtifoV6E0Cwl/pcbRIg4qBg5f5uR2hJ9vjaFaykqOjMaG8WW3gIQWsB10OsQM6loIP2qPENfDUhsTI+Yhd7GzOClSi9L8HcnnMnF83XkgteUhSrOUFGdvY6OQtt/JfnnKcXOOg5//Yj6Dv9/LKOXH7eyZz4f/f7KmZoAX4KUAAAAASUVORK5CYII=");
MinimapReader.energies = {
	botrun: { x: 35, y: -28, img: null },
	toprun: { x: 35, y: -9, img: null },
	topwalk: { x: 35, y: -9, img: null },
	botwalk: { x: 35, y: -28, img: null },
};


function MinimapReader() {
	this.pos = {};

	this.find = function (img) {
		if (!img) { img = a1lib.bindfullrs(); }
		if (!img) { return null; }
		var homeport = a1lib.findsubimg(img, MinimapReader.homeportbutton);
		if (homeport.length == 0) { return null; }
		var botleft = { x: homeport[0].x - 17, y: homeport[0].y + 33 };

		var area = { x: homeport[0].x - 17, y: homeport[0].y - 700 + 33, w: 700, h: 700 };
		if (area.y < 0) { area.h += area.y; area.y = 0; }
		if (area.x + area.w >= img.width) { area.w = img.width - area.x - 1; }

		var topright = null;
		for (var a in MinimapReader.energies) {
			var pos = a1lib.findsubimg(img, MinimapReader.energies[a].img, null, area.x, area.y, area.w, area.h);
			if (pos.length != 0) {
				qw("found energy", a);
				topright = { x: pos[0].x + MinimapReader.energies[a].x, y: pos[0].y + MinimapReader.energies[a].y };
				break;
			}
		}
		if (!topright) { return null; }

		var w = topright.x - botleft.x;
		var h = botleft.y - topright.y
		this.pos = {
			x: botleft.x,
			y: topright.y,
			w: w,
			h: h,
			centerx: w / 2,
			centery: h / 2,
		};
		return this.pos;
	}

	this.readCompass=function(img) {
		if (!this.pos) { return null; }
		var buf;
		if (img) { buf = img.toData(this.pos.x, this.pos.y, 40, 40); }
		else { buf = a1lib.getregion(this.pos.x, this.pos.y, 40, 40); }

		var r = 11;
		var buf2 = buf.clone(new Rect(0, 0, buf.width, buf.height));
		var centerx = 22;
		var centery = 22;

		var sx1 = 0, sy1 = 0, m1 = 0;
		var sx2 = 0, sy2 = 0, m2 = 0;
		for (var x = round(centerx) - r; x <= round(centerx) + r; x++) {
			for (var y = round(centery) - r; y <= round(centery) + r; y++) {
				var i = 4 * x + 4 * buf.width * y;
				var dx = x - centerx;
				var dy = y - centery;
				if (dx * dx + dy * dy > r * r) { buf.data[i] = buf.data[i + 1] = buf.data[i + 2] = 0; continue; }

				var rating1 = buf.data[i] - buf.data[i + 1];
				sx1 += dx * rating1;
				sy1 += dy * rating1;
				m1 += rating1;
				var rating2 = Math.max(0, buf.data[i] + buf.data[i + 1] + buf.data[i + 2] - 300);
				sx2 += dx * rating2;
				sy2 += dy * rating2;
				m2 += rating2;
				if (isNaN(m2)) { debugger; }
				if (isNaN(m1)) { debugger; }

				buf.data[i] = buf.data[i + 1] = buf.data[i + 2] = rating1;
				buf2.data[i] = buf2.data[i + 1] = buf2.data[i + 2] = rating2;
			}
		}
		if (m1 == 0 || m2 == 0) { return null; }

		var mx1 = sx1 / m1;
		var my1 = sy1 / m1;
		var mx2 = sx2 / m2;
		var my2 = sy2 / m2;

		var dir = Math.atan2((my2 - my1), (mx2 - mx1));
		dir += -1 / 180 * Math.PI;
		dir = (Math.PI + dir) % (Math.PI * 2);
		return dir;
	}

	this.readEnergy = function (img) {
		if (!this.pos) { return null; }
		if (!img) { img = a1lib.bindregion(this.pos.x + this.pos.w - 50, this.pos.y + 5, 50, 40); }
		var str = alt1.bindReadColorString(img.handle, "chat", a1lib.mixcolor(255, 255, 255), this.pos.x + this.pos.w - 27 - img.x, this.pos.y + 23 - img.y);
		var m = str.match(/(\d{1,3})%/);
		if (!m) { return null; }
		return +m[1];
	}
}